---
layout: post
title: å›¾ç‰‡å‹ç¼©è„šæœ¬
date: 2022-05-05 15:40:35
subtitle: compress_images
categories: å·¥å…·
tags: 
    - å›¾ç‰‡å‹ç¼©
    - App ç˜¦èº«
---

é€šè¿‡ tinypng æä¾›çš„ api æ‰¹é‡å‹ç¼©å·¥ç¨‹ä¸­ xcassets çš„å›¾ç‰‡ã€‚å¯¹äºå·²å‹ç¼©çš„å›¾ç‰‡ï¼Œåœ¨å›¾ç‰‡çš„ exif ä¿¡æ¯ä¸­æ·»åŠ  Comment å­—æ®µï¼Œé˜²æ­¢é‡å¤å‹ç¼©æ“ä½œã€‚

```rb
def isImageCompressed(path)
  require 'rmagick'
  image = Magick::Image.read(path).first
  result = image["Comment"] 
  return false if result.nil?
  result.include?("Compressed by tinypng")
end

def recordImageCompressed(path)
  require 'rmagick'
  image = Magick::Image.read(path).first
  commnet = image["Comment"].nil? ? "" : "#{image["Comment"]}\n"
  image["Comment"] = commnet + "Compressed by tinypng"
  image.write(path)
end

desc "å‹ç¼©å›¾ç‰‡"
lane :compress_images do
  require "tinify"
  Dir.chdir ".."
  require "json"
  require "tinify"
  keys = ["key1", "key2", "key3"]
  Tinify.key = keys[0]

  puts "å›¾ç‰‡æ£€ç´¢ä¸­..."
  exclude_dirs = ["Pods", "*.bundle"].map { |d| "./dealer/**/#{d}/**/*.{png,jpg}" }
  images = Dir.glob("./dealer/**/*.{png,jpg}")
  images -= Dir.glob(exclude_dirs)
  images = images.select { |image| !isImageCompressed(image) }
  puts "å¾…å‹ç¼©å›¾ç‰‡æ•°é‡: #{images.count}"
  images.each_with_index { |f, i|
    puts "æ­£åœ¨å¤„ç†å›¾ç‰‡: #{f}"
    begin
      Tinify.from_file(f).to_file(f)
      recordImageCompressed(f)
      key_index = (i + 1) / 500
      if key_index < keys.count
        Tinify.key = keys[key_index]
      else
        puts "key ç”¨å®Œäº†, å¿«ç»™æˆ‘æ–° key  (â—ï¾ŸÏ‰ï¾Ÿâ—)"
        break
      end
    rescue => exception
      puts "ğŸ˜­ #{f} å‹ç¼©å¤±è´¥äº†ï¼Œå¤±è´¥åŸå› : #{exception}"
      break
    end
  }
end
```
